<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mall.malladmin.mapper.product.ProductMapper">

    <resultMap id="ProductMap" type="com.mall.malladmin.dto.product.ProductDto">
        <result column="productId" property="productId"/>
        <result column="typeId" property="typeId"/>
        <result column="hits" property="hits"/>
        <result column="productName" property="productName"/>
        <result column="picUrl" property="picUrl"/>
        <result column="priceMin" property="priceMin"/>
        <result column="unit" property="unit"/>
        <result column="isPutaway" property="isPutaway"/>
        <result column="addTime" property="addTime"/>
        <result column="detail" property="detail"/>
        <result column="typeName" property="typeName"/>
    </resultMap>

    <select id="getList" resultMap="ProductMap">
        SELECT
            a.product_Id productId,
            a.type_Id typeId,
            a.product_Name productName,
            a.price_Min priceMin,
            a.unit unit,
            a.pic_Url picUrl,
            a.is_Putaway isPutaway,
            a.hits,
            a.create_time createTime,
            b.type_Name typeName
        FROM mall_product a
        INNER JOIN mall_product_type b ON b.type_id = a.type_id
        where 1 = 1
        AND a.is_delete = '0'
        <if test="dto.productName!=null and dto.productName!=''">
            AND a.product_name like '%${dto.productName}%'
        </if>
        <if test="dto.typeId!=null and dto.typeId!=''">
            AND b.type_Id = #{dto.typeId}
        </if>
        <if test="dto.isPutaway!=null and dto.isPutaway!=''">
            AND a.is_Putaway = #{dto.isPutaway}
        </if>
    </select>

    <select id="findPropertyIsSale" resultType="com.mall.malladmin.dto.product.ProductPropertyDto">
      SELECT concat(a.name,':',b.value) as isSalePropertyString, concat(a.property_name_id,':',b.property_value_id) as isSalePropertyId
        FROM mall_product_property_name a
      INNER JOIN mall_product_property_value b ON  a.property_name_id = b.property_name_id
      WHERE  1= 1
        AND a.is_delete ='0'
        <if test="dto.isSale!=null and dto.isSale!=''">
            AND b.is_sale = #{dto.isSale}
        </if>
        <if test="dto.productId!=null and dto.productId!=''">
            AND b.product_id = #{dto.productId}
        </if>
    </select>
    <select id="findPropertyNotSale" resultType="java.lang.String">
        SELECT concat(b.value) as result FROM mall_product_property_name a
        INNER JOIN mall_product_property_value b ON  a.property_name_id = b.property_name_id
        WHERE  1= 1
        AND a.is_delete = '0'
        <if test="dto.isSale!=null and dto.isSale!=''">
            AND b.is_sale = #{dto.isSale}
        </if>
        <if test="dto.productId!=null and dto.productId!=''">
            AND b.product_id = #{dto.productId}
        </if>
    </select>
    
    <update id="updateProductIsUsable">
        UPDATE
            mall_product a
        SET a.is_usable = #{isUsable}
        WHERE
            a.type_id IN (
                SELECT
                    b.type_id
                FROM
                    mall_product_type b
                WHERE
                    b.type_id = #{typeId}
                UNION ALL
                    SELECT
                        c.type_id
                    FROM
                        mall_product_type c
                    INNER JOIN mall_product_type d ON d.type_id = c.parent_id
                    WHERE
                        d.type_id = #{typeId}
            )
    </update>
</mapper>
        <!--
            <id>：主键字段
            <result>：普通字段
            type：整体封装出的类型
            column：字段名（表里定义好的）
            property：关联属性（查询出来的结果封装成Country里的哪个属性）
            ofType：指定属性类型（关联属性是什么类型）
            <collection>：集合封装
             association:用于配置1对1的映射
                                属性property：company对象在user对象中的属性名
                                属性javaType：company属性的java对象 类型
                                属性column：user表中的外键引用company表
            collection ：配置1对多关系映射
                    property：在user里面的List<Account>的属性名
                    ofType:当前account表的java类型
                    column:外键
                -->